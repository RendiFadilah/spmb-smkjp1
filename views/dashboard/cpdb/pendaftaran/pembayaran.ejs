 <div class="max-w-7xl mx-auto py-8 px-4">
    <!-- Icon and Title -->
    <div class="text-center mb-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-3">Informasi Pembayaran</h3>
        <div class="h-1 w-20 bg-gradient-to-r from-green-400 to-green-600 mx-auto rounded-full mb-4"></div>
    </div>

    <% if (typeof pembayaran !== 'undefined' && pembayaran && typeof detailPembayaran !== 'undefined' && detailPembayaran && detailPembayaran.length > 0) { %>
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Payment Status Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 transition-all duration-300 hover:shadow-xl">
                <div class="p-6 sm:p-8">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div class="flex items-start sm:items-center space-x-4">
                            <div class="<%= detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED') ? 'bg-green-100' : 'bg-yellow-100' %> p-3 rounded-full transform transition-transform duration-300 hover:scale-110">
                                <i class="fas <%= detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED') ? 'fa-check-circle text-green-600' : 'fa-clock text-yellow-600' %> text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl sm:text-2xl font-bold <%= detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED') ? 'text-green-700' : 'text-yellow-700' %>">
                                    <%= detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED') ? 'Pembayaran Terverifikasi' : 'Menunggu Verifikasi' %>
                                </h3>
                                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                                    <%= detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED') ? 'Pembayaran telah diverifikasi oleh admin' : 'Pembayaran sedang dalam proses verifikasi admin' %>
                                </p>
                            </div>
                        </div>
                        <% if (detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED')) { %>
                            <!-- <button onclick="printReceipt()" class="flex items-center px-6 py-3 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                                <i class="fas fa-print mr-2"></i>
                                Cetak Kuitansi
                            </button> -->
                        <% } %>
                    </div>
                </div>
    
                <% if (pembayaran.sisa_pembayaran > 0) { %>
                    <!-- Remaining Payment Alert -->
                    <div class="mx-6 sm:mx-8 mb-6">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle text-yellow-400 text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold text-yellow-800">Informasi Sisa Pembayaran</h3>
                                    <p class="mt-2 text-sm text-yellow-700">
                                        Sisa pembayaran yang harus dilunasi: <span class="font-bold">Rp <%= new Intl.NumberFormat('id-ID').format(pembayaran.sisa_pembayaran) %></span>
                                    </p>
                                    <p class="mt-2 text-sm font-bold text-red-900">Silahkan langsung datang ke bendahara PPDB untuk melunasi pembayarannya</p>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
    
                <!-- Payment History Timeline -->
                <div class="border-t border-gray-100">
                    <div class="p-6 sm:p-8">
                        <h4 class="text-xl font-bold text-gray-800 mb-6">Riwayat Pembayaran</h4>
                        <div class="space-y-8">
                            <% detailPembayaran.forEach((detail, index) => { %>
                                <div class="flex items-start group">
                                    <div class="flex-shrink-0 relative">
                                        <div class="<%= detail.status_verifikasi === 'VERIFIED' ? 'bg-green-100 text-green-600' : detail.status_verifikasi === 'REJECTED' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600' %> p-3 rounded-full transform transition-all duration-300 group-hover:scale-110">
                                            <i class="fas <%= detail.status_verifikasi === 'VERIFIED' ? 'fa-check' : detail.status_verifikasi === 'REJECTED' ? 'fa-times' : 'fa-clock' %> text-lg"></i>
                                        </div>
                                        <% if (index !== detailPembayaran.length - 1) { %>
                                            <div class="absolute left-1/2 transform -translate-x-1/2 h-full w-0.5 bg-gray-200 mt-3"></div>
                                        <% } %>
                                    </div>
                                    <div class="ml-6 flex-grow">
                                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                            <div>
                                                <p class="text-base font-semibold text-gray-900">
                                                    <%= detail.metode_pembayaran === 'TRANSFER' ? 'Pembayaran Transfer' : 'Pembayaran Tunai' %>
                                                </p>
                                                <p class="text-sm text-gray-500"><%= detail.formatted_date %></p>
                                            </div>
                                            <span class="<%= detail.status_verifikasi === 'VERIFIED' ? 'bg-green-100 text-green-800' : detail.status_verifikasi === 'REJECTED' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' %> px-4 py-1.5 rounded-full text-sm font-medium inline-block">
                                                <%= detail.status_verifikasi %>
                                            </span>
                                        </div>
                                        <div class="mt-3 bg-gray-50 rounded-xl p-4">
                                            <p class="text-sm text-gray-700">Nominal: <span class="font-semibold">Rp <%= new Intl.NumberFormat('id-ID').format(detail.nominal_pembayaran) %></span></p>
                                            <% if (detail.metode_pembayaran === 'TRANSFER' && detail.nama_pengirim) { %>
                                                <p class="text-sm text-gray-700 mt-1">Pengirim: <%= detail.nama_pengirim %></p>
                                            <% } %>
                                            <% if (detail.status_verifikasi === 'VERIFIED' && detail.nama_verifikator) { %>
                                                <p class="text-sm text-gray-700 mt-1">Diverifikasi oleh: <%= detail.nama_verifikator %></p>
                                            <% } %>
                                            <% if (detail.bukti_pembayaran) { %>
                                                <button 
                                                    onclick="openImageModal('/uploads/bukti-bayar/<%= detail.bukti_pembayaran %>')"
                                                    class="inline-flex items-center text-sm text-green-600 hover:text-green-700 mt-3 transition-colors duration-200"
                                                >
                                                    <i class="fas fa-image mr-2"></i>
                                                    Lihat Bukti Pembayaran
                                                </button>
                                            <% } %>
                                            <% if (detail.nama_verifikator || detail.catatan_verifikasi) { %>
                                                <div class="mt-3 p-3 bg-gray-100 rounded-lg space-y-2">
                                                    <% if (detail.nama_verifikator) { %>
                                                        <p class="text-sm text-gray-600">
                                                            <i class="fas fa-user text-gray-400 mr-2"></i>
                                                            Diverifikasi oleh: <%= detail.nama_verifikator %>
                                                        </p>
                                                    <% } %>
                                                    <% if (detail.catatan_verifikasi) { %>
                                                        <p class="text-sm text-gray-600">
                                                            <i class="fas fa-comment-alt text-gray-400 mr-2"></i>
                                                            <%= detail.catatan_verifikasi %>
                                                        </p>
                                                    <% } %>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
    
                <% if (detailPembayaran.some(d => d.status_verifikasi === 'VERIFIED')) { %>
                    <!-- WhatsApp Group Information -->
                    <!-- <div class="border-t border-gray-100">
                        <div class="p-6 sm:p-8">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 bg-green-50 p-6 rounded-xl">
                                <div class="flex-shrink-0">
                                    <div class="bg-white p-3 rounded-full shadow-sm">
                                        <i class="fab fa-whatsapp text-3xl text-green-600"></i>
                                    </div>
                                </div>
                                <div class="flex-grow">
                                    <h4 class="text-lg font-bold text-green-800">Bergabung dengan Grup WhatsApp</h4>
                                    <p class="text-green-700 mt-1">Silakan bergabung dengan grup WhatsApp untuk informasi lebih lanjut</p>
                                    <a href="https://chat.whatsapp.com/DSwyJy3Cx2s81K92spNy6G" 
                                       target="_blank" 
                                       class="inline-flex items-center mt-4 px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                                        <i class="fas fa-external-link-alt mr-2"></i>
                                        Gabung Grup WhatsApp
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div> -->
                <% } %>
            </div>
        </div>
    
        <!-- Receipt Print Template (Hidden) -->
        <div id="receiptTemplate" class="hidden">
            <div class="bg-white p-8 max-w-2xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">KUITANSI PEMBAYARAN</h2>
                    <p class="text-gray-600 mt-2">SMK Jakarta Pusat 1</p>
                </div>
                
                <div class="border-t-2 border-b-2 border-gray-200 py-6 mb-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <p class="text-gray-600 text-sm">Telah terima dari:</p>
                            <p class="font-bold text-lg mt-1"><%= registrationRows[0]?.nama_lengkap || '-' %></p>
                        </div>
                        <div class="text-left sm:text-right">
                            <p class="text-gray-600 text-sm">Tanggal:</p>
                            <p class="font-bold text-lg mt-1"><%= new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) %></p>
                        </div>
                    </div>
                </div>
    
                <div class="mb-8">
                    <h3 class="font-bold text-lg mb-4">Detail Pembayaran:</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 text-gray-600">Tanggal</th>
                                <th class="text-left py-3 text-gray-600">Metode</th>
                                <th class="text-right py-3 text-gray-600">Nominal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% detailPembayaran.filter(d => d.status_verifikasi === 'VERIFIED').forEach(detail => { %>
                                <tr class="border-b border-gray-200">
                                    <td class="py-3"><%= detail.formatted_date %></td>
                                    <td class="py-3"><%= detail.metode_pembayaran %></td>
                                    <td class="py-3 text-right">Rp <%= new Intl.NumberFormat('id-ID').format(detail.nominal_pembayaran) %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                        <tfoot>
                            <tr class="font-bold text-lg">
                                <td colspan="2" class="py-4">Total Pembayaran:</td>
                                <td class="py-4 text-right">Rp <%= new Intl.NumberFormat('id-ID').format(detailPembayaran.filter(d => d.status_verifikasi === 'VERIFIED').reduce((sum, d) => sum + parseFloat(d.nominal_pembayaran), 0)) %></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="text-center border-t-2 border-gray-200 pt-6">
                    <p class="text-gray-600">Terima kasih atas pembayaran Anda</p>
                    <p class="text-gray-600 mt-1">Dokumen ini adalah bukti pembayaran yang sah</p>
                </div>
            </div>
        </div>
    
    <% } else { %>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column: Payment Information -->
        <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all duration-300">
            <!-- Payment Success Message -->
         
            <div>
                <h4 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-info-circle text-green-500 mr-3"></i>
                    Informasi Biaya
                </h4>

                <div class="space-y-6">
                    <!-- Selected Jurusan -->
                    <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm relative overflow-hidden hover:shadow-md transition-all duration-300">
                        <div class="absolute top-4 right-4 w-10 h-10 bg-green-500 bg-opacity-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-green-600"></i>
                        </div>
                        <p class="text-sm text-gray-500 mb-1">Jurusan yang Dipilih</p>
                        <p class="text-xl font-bold text-gray-900"><%= registrationRows && registrationRows[0] ? registrationRows[0].nama_jurusan : 'Belum memilih jurusan' %></p>
                    </div>

                    <!-- Payment Amount Cards -->
                    <div class="grid grid-cols-1 gap-4">
                        <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm relative overflow-hidden hover:shadow-md transition-all duration-300">
                            <div class="absolute top-4 right-4 w-10 h-10 bg-green-500 bg-opacity-10 rounded-full flex items-center justify-center">
                                <i class="fas fa-money-bill text-green-600"></i>
                            </div>
                            <p class="text-sm text-gray-500 mb-1">Total Biaya</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalBiaya">
                                <% if (typeof biayaInfo !== 'undefined' && biayaInfo && biayaInfo.total_biaya) { %>
                                    Rp <%= new Intl.NumberFormat('id-ID').format(biayaInfo.total_biaya) %>
                                <% } else { %>
                                    <span class="text-sm text-gray-400">Data tidak tersedia</span>
                                <% } %>
                            </p>
                        </div>

                        <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm relative overflow-hidden hover:shadow-md transition-all duration-300">
                            <div class="absolute top-4 right-4 w-10 h-10 bg-green-500 bg-opacity-10 rounded-full flex items-center justify-center">
                                <i class="fas fa-hand-holding-usd text-green-600"></i>
                            </div>
                            <p class="text-sm text-gray-500 mb-1">Minimal Pembayaran</p>
                            <p class="text-2xl font-bold text-green-600" id="minimalPembayaran">
                                <% if (typeof biayaInfo !== 'undefined' && biayaInfo && biayaInfo.minimal_pembayaran) { %>
                                    Rp <%= new Intl.NumberFormat('id-ID').format(biayaInfo.minimal_pembayaran) %>
                                <% } else { %>
                                    <span class="text-sm text-gray-400">Data tidak tersedia</span>
                                <% } %>
                            </p>
                        </div>
                    </div>

                    <!-- Bank Account Information -->
                    <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm  hover:shadow-md transition-all duration-300 cursor-pointer">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-500 bg-opacity-10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-university text-green-600"></i>
                                </div>
                                <h5 class="text-base font-semibold text-gray-800">Informasi Rekening Bank</h5>
                            </div>
                            <div class="text-green-600 hover:text-green-700 ml-4">
                                <i id="bankToggleIcon" class="fas fa-chevron-down transition-transform duration-300"></i>
                            </div>
                        </div>
                        <div id="bankAccountsList" class="space-y-4 transition-all duration-300 ease-in-out">
                            <!-- Bank Muamalat -->
                            <div class="border-b pb-3">
                                <p class="text-xs text-gray-500">Bank Muamalat</p>
                                <p class="text-xs text-gray-600 mt-1">A.N Yayasan Karyawan dan Guru-Guru Pendidikan Ekonomi Jakarta</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <p class="font-mono text-sm font-semibold text-gray-800">3170010827</p>
                                </div>
                            </div>

                            <!-- Bank DKI -->
                            <div class="border-b pb-3">
                                <p class="text-xs text-gray-500">Bank DKI</p>
                                <p class="text-xs text-gray-600 mt-1">A.N Yayasan Karyawan dan Guru-Guru Pendidikan Ekonomi Jakarta</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <p class="font-mono text-sm font-semibold text-gray-800">51123573161</p>
                                </div>
                            </div>

                            <!-- Bank BCA -->
                            <div class="pb-2">
                                <p class="text-xs text-gray-500">Bank BCA</p>
                                <p class="text-xs text-gray-600 mt-1">A.N Yayasan Karyawan dan Guru-Guru Pendidikan Ekonomi Jakarta</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <p class="font-mono text-sm font-semibold text-gray-800">5740346999</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          
        </div>

<!-- Right Column: Payment Information -->
        <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all duration-300" id="paymentInfoContainer">
            <h4 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-info-circle text-green-500 mr-3"></i>
                Informasi Pembayaran
            </h4>

            <div class="space-y-6">
                <!-- Payment Methods -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <h5 class="font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-credit-card text-green-500 mr-2"></i>
                        Metode Pembayaran
                    </h5>
                    <div class="space-y-3 text-gray-600">
                        <div class="flex items-start">
                            <i class="fas fa-building mt-1 text-green-500 mr-3"></i>
                            <div>
                                <p class="font-medium">Kasir Sekolah</p>
                                <p class="text-sm">Pembayaran dapat dilakukan langsung di kasir sekolah</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-university mt-1 text-green-500 mr-3"></i>
                            <div>
                                <p class="font-medium">Transfer Bank</p>
                                <p class="text-sm">Pembayaran dapat dilakukan melalui transfer bank dengan konfirmasi via WhatsApp</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h5 class="font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fab fa-whatsapp text-green-500 mr-2"></i>
                        Konfirmasi Pembayaran
                    </h5>
                    <p class="text-gray-600 mb-4">
                        Untuk konfirmasi pembayaran atau informasi lebih lanjut, silakan hubungi kami melalui WhatsApp:
                    </p>
                    <a href="https://wa.me/6285159998772?text=Saya%20ingin%20melakukan%20pembayaran%20SPMB%20SMK%20Jakarta%20Timur%20Tahun%202025%2F2026%20melalui%20transfer" 
                       target="_blank"
                       class="group relative px-6 py-3 bg-gradient-to-br from-green-500 via-green-600 to-green-700 text-white rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-xl overflow-hidden inline-flex items-center">
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-white/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <i class="fab fa-whatsapp text-xl mr-2"></i>
                        <span class="font-semibold">Hubungi via WhatsApp</span>
                    </a>
                </div>

                <!-- Important Notes -->
                <div class="bg-blue-50 rounded-xl p-6">
                    <h5 class="font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-sticky-note text-blue-500 mr-2"></i>
                        Catatan Penting
                    </h5>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Simpan bukti pembayaran sebagai bukti transaksi yang sah</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Konfirmasi pembayaran akan diproses pada jam kerja</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Status pembayaran akan diupdate setelah konfirmasi diterima</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <% } %>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 sm:p-6 md:p-8">
    <div class="relative max-w-4xl w-full mx-auto">
        <!-- Close button -->
        <button 
            onclick="closeImageModal()" 
            class="absolute -top-10 right-0 text-white hover:text-gray-300"
        >
            <i class="fas fa-times text-2xl"></i>
        </button>
        
        <!-- Image container -->
        <div class="bg-white rounded-lg p-2">
            <img id="modalImage" src="" alt="Bukti Pembayaran" class="w-full h-auto rounded">
        </div>
    </div>
</div>

<script>
// Image Modal Functions
function openImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    modalImage.src = imageSrc;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Close modal when clicking outside
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeImageModal();
        }
    };
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Close modal with escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Drag and drop functionality remains the same
const dropZone = document.querySelector('form');
const fileInput = document.getElementById('bukti_pembayaran');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.classList.add('border-green-500');
}

function unhighlight(e) {
    dropZone.classList.remove('border-green-500');
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    fileInput.files = files;
    previewImage(fileInput);
}


// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const bankAccountsContainer = document.querySelector('[onclick*="toggleBankAccounts"]');
    if (bankAccountsContainer) {
        bankAccountsContainer.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleBankAccounts();
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const initialPaymentInfo = document.getElementById('initialPaymentInfo');
    const paymentHistory = document.getElementById('paymentHistory');
    const submitPaymentForm = document.getElementById('submitPaymentForm');
    const metodePembayaran = document.querySelector('select[name="metode_pembayaran"]');
    const namaPengirimContainer = document.getElementById('namaPengirimContainer');
    const namaPengirimInput = document.getElementById('nama_pengirim');

    // Function to toggle nama_pengirim field with animation
    function toggleNamaPengirim() {
        if (!metodePembayaran) return; // Check if element exists
        
        if (metodePembayaran.value === 'TRANSFER') {
            if (namaPengirimContainer) {
                namaPengirimContainer.style.display = 'block';
                namaPengirimContainer.style.opacity = '0';
                setTimeout(() => {
                    namaPengirimContainer.style.opacity = '1';
                    namaPengirimContainer.style.transform = 'translateY(0)';
                }, 50);
            }
            if (namaPengirimInput) namaPengirimInput.required = true;
        } else {
            if (namaPengirimContainer) {
                namaPengirimContainer.style.opacity = '0';
                namaPengirimContainer.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    namaPengirimContainer.style.display = 'none';
                }, 300);
            }
            if (namaPengirimInput) {
                namaPengirimInput.required = false;
                namaPengirimInput.value = ''; // Clear the value when hidden
            }
        }
    }

    // Add event listener for payment method change
    if (metodePembayaran) {
        metodePembayaran.addEventListener('change', toggleNamaPengirim);
        // Initial check on page load
        toggleNamaPengirim();
    }

    // Function to preview uploaded image with enhanced preview
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const uploadIcon = document.getElementById('uploadIcon');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Create remove button if it doesn't exist
                let removeBtn = previewContainer.querySelector('.remove-preview');
                if (!removeBtn) {
                    removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-preview absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600 transition-colors duration-200';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = function(e) {
                        e.preventDefault();
                        // Clear the file input
                        input.value = '';
                        // Hide preview
                        previewContainer.classList.add('hidden');
                        uploadIcon.classList.remove('hidden');
                        // Remove the preview image source
                        preview.src = '';
                    };
                    previewContainer.appendChild(removeBtn);
                }

                preview.src = e.target.result;
                preview.style.maxHeight = '200px';
                preview.style.width = 'auto';
                preview.style.margin = '0 auto';
                preview.style.borderRadius = '8px';
                preview.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                
                // Show preview with animation
                previewContainer.style.opacity = '0';
                previewContainer.classList.remove('hidden');
                uploadIcon.classList.add('hidden');
                
                setTimeout(() => {
                    previewContainer.style.opacity = '1';
                    previewContainer.style.transform = 'translateY(0)';
                }, 50);
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('id-ID', { 
            style: 'currency', 
            currency: 'IDR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'PENDING':
                return 'bg-yellow-100 text-yellow-800';
            case 'VERIFIED':
                return 'bg-green-100 text-green-800';
            case 'REJECTED':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    async function loadBiayaInfo(idJurusan) {
        try {
            console.log('Loading biaya for jurusan:', idJurusan);
            const response = await fetch(`/api/cpdb/pembayaran/biaya/${idJurusan}`);
            
            if (!response.ok) {
                console.error('Failed to fetch biaya info, status:', response.status);
                // Set error message
                const totalBiayaElement = document.getElementById('totalBiaya');
                const minimalPembayaranElement = document.getElementById('minimalPembayaran');
                if (totalBiayaElement) {
                    totalBiayaElement.textContent = 'Data tidak tersedia';
                    totalBiayaElement.classList.add('text-sm');
                }
                if (minimalPembayaranElement) {
                    minimalPembayaranElement.textContent = 'Data tidak tersedia';
                    minimalPembayaranElement.classList.add('text-sm');
                }
                return;
            }
            
            const result = await response.json();
            console.log('Biaya info result:', result);
            
            if (result.success && result.data) {
                const biaya = result.data;
                
                // Update total biaya
                const totalBiayaElement = document.getElementById('totalBiaya');
                if (totalBiayaElement) {
                    totalBiayaElement.textContent = formatCurrency(biaya.total_biaya);
                }
                
                // Update minimal pembayaran
                const minimalPembayaranElement = document.getElementById('minimalPembayaran');
                if (minimalPembayaranElement) {
                    minimalPembayaranElement.textContent = formatCurrency(biaya.minimal_pembayaran);
                }
                
                console.log('Biaya loaded successfully');
            } else {
                console.error('Biaya data not found in response');
            }
        } catch (error) {
            console.error('Error loading biaya info:', error);
            // Set error message
            const totalBiayaElement = document.getElementById('totalBiaya');
            const minimalPembayaranElement = document.getElementById('minimalPembayaran');
            if (totalBiayaElement) {
                totalBiayaElement.textContent = 'Error loading data';
                totalBiayaElement.classList.add('text-sm');
            }
            if (minimalPembayaranElement) {
                minimalPembayaranElement.textContent = 'Error loading data';
                minimalPembayaranElement.classList.add('text-sm');
            }
        }
    }

    async function loadPaymentInfo() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const idFormulir = urlParams.get('id_formulir');
            const response = await fetch(`/api/cpdb/pembayaran/${idFormulir}?tahun_ajaran=${urlParams.get('tahun_ajaran')}&idJurusan=${urlParams.get('id_jurusan')}`);
            
            if (!response.ok) throw new Error('Failed to fetch payment info');
            
            const data = await response.json();
            console.log('Payment info:', data);


            // Get registration data
            const registrationData = data.registrasi;
            console.log('Registration data:', registrationData);

            // Load biaya dinamis berdasarkan jurusan dan periode aktif
            if (registrationData?.id_jurusan) {
                await loadBiayaInfo(registrationData.id_jurusan);
            }

            // Get all relevant sections
            const initialPaymentInfo = document.querySelector('.space-y-6').parentElement;
            const paymentFormContainer = document.getElementById('paymentFormContainer');
            const keteranganSection = document.querySelector('.mt-8');
            const paymentHistory = document.querySelector('.mt-8:last-child');
            const paymentSuccessMessage = document.querySelector('.mb-6');

            // Handle visibility based on payment status
            if (!data.pembayaran || !data.detailPembayaran || data.detailPembayaran.length === 0) {
                // Show initial payment info and form
                initialPaymentInfo.classList.remove('hidden');
                paymentFormContainer.classList.remove('hidden');
                
                // Hide payment status sections
                keteranganSection?.classList?.add('hidden');
                paymentHistory?.classList?.add('hidden');
                paymentSuccessMessage?.classList?.add('hidden');

                // Update jurusan name if available
                if (registrationData?.nama_jurusan) {
                    const jurusanElement = document.querySelector('.text-xl.font-bold.text-gray-900');
                    if (jurusanElement) {
                        jurusanElement.textContent = registrationData.nama_jurusan;
                    }
                }

                return; // Exit early as there's no payment data to display
            }

            // Check payment existence and status
            const hasPayment = data.pembayaran && data.detailPembayaran && data.detailPembayaran.length > 0;
            const hasVerifiedPayment = hasPayment && data.detailPembayaran.some(detail => detail.status === 'VERIFIED');
            const hasPendingPayment = hasPayment && data.detailPembayaran.some(detail => detail.status === 'PENDING');
            
            // Handle visibility based on payment status
            if (hasPayment) {
                // Hide initial payment info and form
                initialPaymentInfo.classList.add('hidden');
                paymentFormContainer.classList.add('hidden');
                
                // Show payment status sections
                keteranganSection?.classList?.remove('hidden');
                paymentHistory?.classList?.remove('hidden');
                
                // Update payment status message
                if (paymentSuccessMessage) {
                    paymentSuccessMessage.classList.remove('hidden');
                    const messageBox = paymentSuccessMessage.querySelector('div');
                    const icon = messageBox.querySelector('i');
                    const text = messageBox.querySelector('h3');
                    
                    if (hasVerifiedPayment) {
                        messageBox.className = 'bg-green-50 border-green-500 border-l-4 p-4 rounded-lg';
                        icon.className = 'fas fa-check-circle text-green-500 text-2xl';
                        text.className = 'text-lg font-medium text-green-800';
                        text.textContent = 'Pembayaran telah diverifikasi oleh admin.';
                    } else if (hasPendingPayment) {
                        messageBox.className = 'bg-yellow-50 border-yellow-500 border-l-4 p-4 rounded-lg';
                        icon.className = 'fas fa-clock text-yellow-500 text-2xl';
                        text.className = 'text-lg font-medium text-yellow-800';
                        text.textContent = 'Pembayaran sedang dalam proses verifikasi admin.';
                    }
                }
            } else {
                // Show initial payment info and payment form
                initialPaymentInfo.classList.remove('hidden');
                document.getElementById('paymentFormContainer').classList.remove('hidden');
                
                // Hide payment status sections
                keteranganSection.classList.add('hidden');
                paymentHistory.classList.add('hidden');
                paymentSuccessMessage.classList.add('hidden');
            }

                // Update payment history
                const historyBody = document.getElementById('paymentHistoryBody');
                historyBody.innerHTML = ''; // Clear existing rows

                let totalPaid = 0;
                data.detailPembayaran.forEach(detail => {
                    if (detail.status === 'VERIFIED') {
                        totalPaid += parseFloat(detail.nominal_pembayaran);
                    }

                    const row = document.createElement('tr');
                    
                    // Create and append date cell
                    const dateCell = document.createElement('td');
                    dateCell.className = 'px-6 py-4 whitespace-nowrap';
                    dateCell.textContent = formatDate(detail.tanggal_pembayaran);
                    row.appendChild(dateCell);
                    
                    // Create and append payment method cell
                    const methodCell = document.createElement('td');
                    methodCell.className = 'px-6 py-4 whitespace-nowrap';
                    methodCell.textContent = detail.metode_pembayaran;
                    row.appendChild(methodCell);
                    
                    // Create and append amount cell
                    const amountCell = document.createElement('td');
                    amountCell.className = 'px-6 py-4 whitespace-nowrap';
                    amountCell.textContent = formatCurrency(detail.nominal_pembayaran);
                    row.appendChild(amountCell);
                    
                    // Create and append status cell
                    const statusCell = document.createElement('td');
                    statusCell.className = 'px-6 py-4 whitespace-nowrap';
                    const statusSpan = document.createElement('span');
                    statusSpan.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(detail.status)}`;
                    statusSpan.textContent = detail.status;
                    statusCell.appendChild(statusSpan);
                    row.appendChild(statusCell);
                    
                    // Create and append proof cell
                    const proofCell = document.createElement('td');
                    proofCell.className = 'px-6 py-4 whitespace-nowrap';
                    
                    if (detail.bukti_pembayaran) {
                        const viewButton = document.createElement('button');
                        viewButton.className = 'text-green-600 hover:text-green-800';
                        viewButton.innerHTML = '<i class="fas fa-eye"></i> Lihat';
                        viewButton.addEventListener('click', () => {
                            openImageModal('/uploads/bukti-bayar/' + detail.bukti_pembayaran);
                        });
                        proofCell.appendChild(viewButton);
                    } else {
                        proofCell.textContent = '-';
                    }
                    
                    row.appendChild(proofCell);
                    historyBody.appendChild(row);
                });

                // Update payment status
                const totalBiaya = data.pembayaran.total_biaya;
                const remainingPayment = totalBiaya - totalPaid;
                document.getElementById('sisaPembayaran').textContent = formatCurrency(remainingPayment);
                
                const statusElement = document.getElementById('statusPelunasan');
                if (remainingPayment <= 0) {
                    statusElement.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-green-600 font-semibold">Status: Lunas</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Total Pembayaran: ${formatCurrency(totalBiaya)}</p>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-clock text-yellow-500"></i>
                            <span class="text-yellow-600 font-semibold">Status: Belum Lunas</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">
                            Total Biaya: ${formatCurrency(totalBiaya)}<br>
                            Sudah Dibayar: ${formatCurrency(totalPaid)}<br>
                            Sisa Pembayaran: ${formatCurrency(remainingPayment)}
                        </p>
                    `;
                }

        } catch (error) {
            console.error('Error loading payment info:', error);
            showToast('Gagal memuat informasi pembayaran', 'error');
        }
    }

    // Toast notification system
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 mb-4 transform translate-x-full transition-transform duration-300`;
        toast.innerHTML = `
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);
        
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                container.removeChild(toast);
            }, 300);
        }, 5000);
    }

    // Copy to clipboard functionality
    window.copyToClipboard = function(text) {
        var tempInput = document.createElement('input');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        
        try {
            tempInput.select();
            document.execCommand('copy');
            showToast('Nomor rekening berhasil disalin!', 'success');
        } catch (err) {
            showToast('Gagal menyalin nomor rekening', 'error');
        } finally {
            document.body.removeChild(tempInput);
        }
    };

    if (submitPaymentForm) {
        submitPaymentForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            // Get form elements
            const metode = this.querySelector('[name="metode_pembayaran"]').value;
            const nominal = this.querySelector('[name="nominal_pembayaran"]').value;
            const namaPengirim = this.querySelector('[name="nama_pengirim"]');
            const buktiPembayaran = this.querySelector('[name="bukti_pembayaran"]');
            const urlParams = new URLSearchParams(window.location.search);

            // Client-side validation
            if (!nominal) {
                throw new Error('Silakan pilih nominal pembayaran');
            }

            if (metode === 'TRANSFER') {
                if (!namaPengirim.value.trim()) {
                    throw new Error('Nama pengirim wajib diisi untuk pembayaran transfer');
                }

                if (!buktiPembayaran.files || !buktiPembayaran.files[0]) {
                    throw new Error('Bukti pembayaran wajib diupload untuk pembayaran transfer');
                }

                const file = buktiPembayaran.files[0];
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('Ukuran file maksimal 10MB');
                }

                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('Format file harus JPG, JPEG, atau PNG');
                }
            }

            // Get registration data
            const registrationData = JSON.parse(this.dataset.registrationData || '[]');
            console.log('Registration data:', registrationData);

            // Get IDs from registration data or URL params
            const idFormulir = registrationData[0]?.id_formulir;
            const idJurusan = registrationData[0]?.id_jurusan;

            console.log('Form IDs:', { idFormulir, idJurusan });

            if (!idFormulir || !idJurusan) {
                throw new Error('Data formulir atau jurusan tidak lengkap. Silakan refresh halaman dan coba lagi.');
            }

            // Create FormData and append required fields
            const formData = new FormData();
            formData.append('id_formulir', idFormulir.toString());
            formData.append('id_jurusan', idJurusan.toString());
            formData.append('metode_pembayaran', metode);
            formData.append('nominal_pembayaran', nominal);

            console.log('Form data:', {
                id_formulir: idFormulir,
                id_jurusan: idJurusan,
                metode_pembayaran: metode,
                nominal_pembayaran: nominal
            });

            if (metode === 'TRANSFER') {
                formData.append('nama_pengirim', namaPengirim.value.trim());
                formData.append('bukti_pembayaran', buktiPembayaran.files[0]);
            }

            // Submit payment
            const response = await fetch('/api/cpdb/pembayaran', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Gagal submit pembayaran');
            }

            // Success handling
            showToast('Pembayaran berhasil disubmit', 'success');
            
            // Reset form and UI
            this.reset();
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('uploadIcon').classList.remove('hidden');
            
            // Reload payment info
            await loadPaymentInfo();

            // Redirect to prevent double submission
            window.location.reload();

        } catch (error) {
            console.error('Error submitting payment:', error);
            showToast(error.message || 'Terjadi kesalahan saat submit pembayaran', 'error');
        } finally {
            // Reset button state
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <i class="fas fa-paper-plane"></i>
                    <span class="font-bold">Submit Pembayaran</span>
                </div>
            `;
        }
        });
    }

    // Initial load
    loadPaymentInfo();
    
    // Load biaya info from server-side data if available
    <% if (typeof registrationRows !== 'undefined' && registrationRows && registrationRows[0] && registrationRows[0].id_jurusan) { %>
        // Load biaya for current jurusan from server-side data
        const serverSideJurusanId = <%= registrationRows[0].id_jurusan %>;
        console.log('Loading biaya from server-side data, jurusan ID:', serverSideJurusanId);
        loadBiayaInfo(serverSideJurusanId);
    <% } %>
});