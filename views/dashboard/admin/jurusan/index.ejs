<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Manajemen Jurusan</h1>
        <p class="mt-1 text-sm text-gray-500">Kelola data jurusan dan kapasitas penerimaan</p>
    </div>
    <button type="button" onclick="openAddModal()"
        class="inline-flex items-center gap-2 px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-semibold rounded-xl shadow-lg shadow-brand-500/25 hover:shadow-xl hover:shadow-brand-500/30 transition-all duration-200 hover:-translate-y-0.5">
        <i class="fas fa-plus text-xs"></i>
        Tambah Jurusan
    </button>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
    <!-- Total Jurusan -->
    <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-gray-100/50 transition-all duration-300">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-brand-50 flex items-center justify-center shrink-0">
                <i class="fas fa-graduation-cap text-brand-600"></i>
            </div>
            <div>
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Total Jurusan</p>
                <p class="text-2xl font-bold text-gray-900 mt-0.5" id="totalJurusan">-</p>
            </div>
        </div>
    </div>
    <!-- Total Kapasitas -->
    <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-gray-100/50 transition-all duration-300">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center shrink-0">
                <i class="fas fa-users text-blue-600"></i>
            </div>
            <div>
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Total Kapasitas</p>
                <p class="text-2xl font-bold text-gray-900 mt-0.5" id="totalKapasitas">-</p>
            </div>
        </div>
    </div>
    <!-- Total Sisa -->
    <div class="bg-white rounded-2xl border border-gray-100 p-5 hover:shadow-lg hover:shadow-gray-100/50 transition-all duration-300">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-emerald-50 flex items-center justify-center shrink-0">
                <i class="fas fa-chair text-emerald-600"></i>
            </div>
            <div>
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Sisa Kapasitas</p>
                <p class="text-2xl font-bold text-gray-900 mt-0.5" id="totalSisa">-</p>
            </div>
        </div>
    </div>
</div>

<!-- Search -->
<div class="mb-6">
    <div class="relative max-w-md">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400 text-sm"></i>
        </div>
        <input type="text" id="searchInput"
            class="w-full pl-11 pr-10 py-2.5 bg-white border border-gray-200 rounded-xl text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all duration-200"
            placeholder="Cari jurusan atau kode...">
        <button id="clearSearch" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 transition-colors hidden">
            <i class="fas fa-times text-sm"></i>
        </button>
    </div>
</div>

<!-- Table Card -->
<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-100">
                    <th class="px-6 py-4 text-left text-[11px] font-bold text-gray-400 uppercase tracking-wider">Jurusan</th>
                    <th class="px-6 py-4 text-left text-[11px] font-bold text-gray-400 uppercase tracking-wider">Kode</th>
                    <th class="px-6 py-4 text-center text-[11px] font-bold text-gray-400 uppercase tracking-wider">Kapasitas</th>
                    <th class="px-6 py-4 text-center text-[11px] font-bold text-gray-400 uppercase tracking-wider">Sisa Kapasitas</th>
                    <th class="px-6 py-4 text-center text-[11px] font-bold text-gray-400 uppercase tracking-wider">Terisi</th>
                    <th class="px-6 py-4 text-right text-[11px] font-bold text-gray-400 uppercase tracking-wider">Aksi</th>
                </tr>
            </thead>
            <tbody id="jurusanTableBody" class="divide-y divide-gray-50">
                <!-- Rows populated by JS -->
            </tbody>
        </table>
    </div>
    <!-- Empty State -->
    <div id="emptyState" class="hidden py-16 text-center">
        <div class="w-16 h-16 rounded-2xl bg-gray-50 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-graduation-cap text-2xl text-gray-300"></i>
        </div>
        <p class="text-sm font-medium text-gray-400">Belum ada data jurusan</p>
        <p class="text-xs text-gray-300 mt-1">Klik "Tambah Jurusan" untuk menambahkan</p>
    </div>
</div>

<!-- ===== ADD/EDIT MODAL ===== -->
<div id="jurusanModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('jurusanModal')"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0" id="jurusanModalContent">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
                <div>
                    <h3 class="text-lg font-bold text-gray-900" id="modalTitle">Tambah Jurusan</h3>
                    <p class="text-xs text-gray-400 mt-0.5" id="modalSubtitle">Isi data jurusan baru</p>
                </div>
                <button type="button" onclick="closeModal('jurusanModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <!-- Form -->
            <form id="jurusanForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="jurusanId" name="id_jurusan">
                <div class="px-6 py-6 space-y-5">
                    <!-- Nama Jurusan -->
                    <div>
                        <label for="jurusan" class="block text-sm font-semibold text-gray-700 mb-1.5">Nama Jurusan</label>
                        <input type="text" name="jurusan" id="jurusan" required
                            class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all duration-200"
                            placeholder="Contoh: Rekayasa Perangkat Lunak">
                    </div>
                    <!-- Kode Jurusan -->
                    <div>
                        <label for="kode" class="block text-sm font-semibold text-gray-700 mb-1.5">Kode Jurusan</label>
                        <input type="text" name="kode" id="kode" required
                            class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all duration-200 uppercase"
                            placeholder="Contoh: RPL" maxlength="10">
                    </div>
                    <!-- Kapasitas & Sisa Kapasitas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="kapasitas" class="block text-sm font-semibold text-gray-700 mb-1.5">Kapasitas</label>
                            <input type="number" id="kapasitas" name="kapasitas" required min="1"
                                class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all duration-200"
                                placeholder="0">
                        </div>
                        <div id="sisaKapasitasField" class="hidden">
                            <label for="sisa_kapasitas" class="block text-sm font-semibold text-gray-700 mb-1.5">Sisa Kapasitas</label>
                            <input type="number" id="sisa_kapasitas" name="sisa_kapasitas" min="0"
                                class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all duration-200"
                                placeholder="0">
                            <p class="text-[11px] text-amber-600 mt-1.5 flex items-center gap-1">
                                <i class="fas fa-triangle-exclamation text-[10px]"></i>
                                Hati-hati mengubah manual sisa kapasitas
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Footer -->
                <div class="flex items-center justify-end gap-3 px-6 py-4 bg-gray-50/50 border-t border-gray-100 rounded-b-2xl">
                    <button type="button" onclick="closeModal('jurusanModal')"
                        class="px-5 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-all duration-200">
                        Batal
                    </button>
                    <button type="submit"
                        class="px-5 py-2.5 text-sm font-semibold text-white bg-brand-600 rounded-xl hover:bg-brand-700 shadow-lg shadow-brand-500/25 hover:shadow-xl hover:shadow-brand-500/30 transition-all duration-200">
                        <i class="fas fa-check mr-1.5 text-xs"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===== DELETE MODAL ===== -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('deleteModal')"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0" id="deleteModalContent">
            <div class="px-6 py-8 text-center">
                <div class="w-16 h-16 rounded-2xl bg-red-50 flex items-center justify-center mx-auto mb-5">
                    <i class="fas fa-trash-can text-2xl text-red-500"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Hapus Jurusan?</h3>
                <p class="text-sm text-gray-500 mb-8">Data yang dihapus tidak dapat dikembalikan. Pastikan jurusan ini tidak memiliki siswa terdaftar.</p>
                <div class="flex items-center gap-3 justify-center">
                    <button type="button" onclick="closeModal('deleteModal')"
                        class="px-5 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-all duration-200">
                        Batal
                    </button>
                    <button type="button" onclick="confirmDelete()"
                        class="px-5 py-2.5 text-sm font-semibold text-white bg-red-600 rounded-xl hover:bg-red-700 shadow-lg shadow-red-500/25 transition-all duration-200">
                        <i class="fas fa-trash-can mr-1.5 text-xs"></i>
                        Ya, Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedId = null;
let allData = [];

const colorMap = {
    'RPL': { bg: 'bg-indigo-50', text: 'text-indigo-700', badge: 'bg-indigo-100 text-indigo-700', bar: 'bg-indigo-500' },
    'AK':  { bg: 'bg-blue-50',   text: 'text-blue-700',   badge: 'bg-blue-100 text-blue-700',   bar: 'bg-blue-500' },
    'AKL': { bg: 'bg-blue-50',   text: 'text-blue-700',   badge: 'bg-blue-100 text-blue-700',   bar: 'bg-blue-500' },
    'MP':  { bg: 'bg-emerald-50', text: 'text-emerald-700', badge: 'bg-emerald-100 text-emerald-700', bar: 'bg-emerald-500' },
    'BR':  { bg: 'bg-violet-50', text: 'text-violet-700', badge: 'bg-violet-100 text-violet-700', bar: 'bg-violet-500' },
    'BD':  { bg: 'bg-amber-50',  text: 'text-amber-700',  badge: 'bg-amber-100 text-amber-700',  bar: 'bg-amber-500' },
    'BDP': { bg: 'bg-amber-50',  text: 'text-amber-700',  badge: 'bg-amber-100 text-amber-700',  bar: 'bg-amber-500' },
    'DKV': { bg: 'bg-pink-50',   text: 'text-pink-700',   badge: 'bg-pink-100 text-pink-700',   bar: 'bg-pink-500' },
    'TKJ': { bg: 'bg-cyan-50',   text: 'text-cyan-700',   badge: 'bg-cyan-100 text-cyan-700',   bar: 'bg-cyan-500' },
    'OTKP': { bg: 'bg-orange-50', text: 'text-orange-700', badge: 'bg-orange-100 text-orange-700', bar: 'bg-orange-500' },
};
const defaultColor = { bg: 'bg-gray-50', text: 'text-gray-700', badge: 'bg-gray-100 text-gray-700', bar: 'bg-gray-500' };

$(document).ready(function () {
    loadJurusanData();

    const searchInput = $('#searchInput');
    const clearButton = $('#clearSearch');

    searchInput.on('input', function () {
        clearButton.toggleClass('hidden', !$(this).val().length);
        filterData();
    });
    clearButton.on('click', function () {
        searchInput.val('');
        $(this).addClass('hidden');
        filterData();
        searchInput.focus();
    });
});

function loadJurusanData() {
    $.get('/api/admin/jurusan', function (data) {
        allData = data;
        updateStats();
        filterData();
    }).fail(function () {
        showToast('Gagal memuat data jurusan', 'error');
    });
}

function updateStats() {
    const totalJurusan = allData.length;
    const totalKapasitas = allData.reduce((s, j) => s + parseInt(j.kapasitas || 0), 0);
    const totalSisa = allData.reduce((s, j) => s + parseInt(j.sisa_kapasitas || 0), 0);

    animateNumber('#totalJurusan', totalJurusan);
    animateNumber('#totalKapasitas', totalKapasitas);
    animateNumber('#totalSisa', totalSisa);
}

function animateNumber(selector, target) {
    const el = $(selector);
    const current = parseInt(el.text()) || 0;
    if (current === target) { el.text(target); return; }
    const duration = 400;
    const steps = 20;
    const increment = (target - current) / steps;
    let step = 0;
    const timer = setInterval(() => {
        step++;
        if (step >= steps) {
            el.text(target);
            clearInterval(timer);
        } else {
            el.text(Math.round(current + increment * step));
        }
    }, duration / steps);
}

function filterData() {
    const q = $('#searchInput').val().toLowerCase();
    const filtered = q ? allData.filter(j =>
        j.jurusan.toLowerCase().includes(q) || j.kode.toLowerCase().includes(q)
    ) : allData;
    renderTable(filtered);
}

function renderTable(data) {
    const tbody = $('#jurusanTableBody');
    const empty = $('#emptyState');

    tbody.empty();

    if (!data.length) {
        empty.removeClass('hidden');
        return;
    }
    empty.addClass('hidden');

    data.forEach((j, i) => {
        const c = colorMap[j.kode] || defaultColor;
        const terisi = parseInt(j.kapasitas) - parseInt(j.sisa_kapasitas);
        const persen = j.kapasitas > 0 ? Math.round((terisi / j.kapasitas) * 100) : 0;
        const barColor = persen >= 90 ? 'bg-red-500' : persen >= 70 ? 'bg-amber-500' : c.bar;

        const row = `
            <tr class="group hover:bg-gray-50/80 transition-colors duration-150" style="animation: fadeSlideIn 0.3s ease-out ${i * 0.05}s both;">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-xl ${c.bg} flex items-center justify-center shrink-0">
                            <i class="fas fa-graduation-cap text-sm ${c.text}"></i>
                        </div>
                        <span class="text-sm font-semibold text-gray-900">${j.jurusan}</span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold ${c.badge}">${j.kode}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="text-sm font-semibold text-gray-900">${j.kapasitas}</span>
                    <span class="text-xs text-gray-400 ml-1">siswa</span>
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="text-sm font-semibold ${j.sisa_kapasitas <= 5 ? 'text-red-600' : 'text-gray-900'}">${j.sisa_kapasitas}</span>
                    <span class="text-xs text-gray-400 ml-1">siswa</span>
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center justify-center gap-3">
                        <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full rounded-full ${barColor} transition-all duration-700" style="width: ${persen}%"></div>
                        </div>
                        <span class="text-xs font-bold ${persen >= 90 ? 'text-red-600' : 'text-gray-500'} min-w-[36px] text-right">${persen}%</span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center justify-end gap-1">
                        <button onclick="editJurusan(${j.id_jurusan})" title="Edit"
                            class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-brand-600 hover:bg-brand-50 transition-all duration-200">
                            <i class="fas fa-pen-to-square text-sm"></i>
                        </button>
                        <button onclick="deleteJurusan(${j.id_jurusan})" title="Hapus"
                            class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 transition-all duration-200">
                            <i class="fas fa-trash-can text-sm"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        tbody.append(row);
    });
}

// ===== Modal Functions =====
function openAddModal() {
    $('#modalTitle').text('Tambah Jurusan');
    $('#modalSubtitle').text('Isi data jurusan baru');
    $('#jurusanForm')[0].reset();
    $('#jurusanId').val('');
    $('#sisaKapasitasField').addClass('hidden');
    openModal('jurusanModal');
}

function editJurusan(id) {
    selectedId = id;
    $('#modalTitle').text('Edit Jurusan');
    $('#modalSubtitle').text('Ubah data dan kapasitas jurusan');

    $.get(`/api/admin/jurusan/${id}`, function (data) {
        $('#jurusanId').val(data.id_jurusan);
        $('#jurusan').val(data.jurusan);
        $('#kode').val(data.kode);
        $('#kapasitas').val(data.kapasitas);
        $('#sisa_kapasitas').val(data.sisa_kapasitas);
        $('#sisaKapasitasField').removeClass('hidden');
        openModal('jurusanModal');
    }).fail(function () {
        showToast('Gagal memuat data jurusan', 'error');
    });
}

function deleteJurusan(id) {
    selectedId = id;
    openModal('deleteModal');
}

function confirmDelete() {
    if (!selectedId) return;
    $.ajax({
        url: `/api/admin/jurusan/${selectedId}`,
        type: 'DELETE',
        success: function () {
            closeModal('deleteModal');
            loadJurusanData();
            showToast('Jurusan berhasil dihapus');
        },
        error: function () {
            showToast('Gagal menghapus jurusan', 'error');
        }
    });
}

function handleSubmit(event) {
    event.preventDefault();

    const isEdit = !!$('#jurusanId').val();
    const formData = {
        jurusan: $('#jurusan').val(),
        kode: $('#kode').val().toUpperCase(),
        kapasitas: parseInt($('#kapasitas').val())
    };

    if (isEdit) {
        formData.sisa_kapasitas = parseInt($('#sisa_kapasitas').val());
    }

    const url = isEdit ? `/api/admin/jurusan/${$('#jurusanId').val()}` : '/api/admin/jurusan';
    const method = isEdit ? 'PUT' : 'POST';

    $.ajax({
        url, type: method, data: formData,
        success: function () {
            closeModal('jurusanModal');
            loadJurusanData();
            showToast(`Jurusan berhasil ${isEdit ? 'diperbarui' : 'ditambahkan'}`);
        },
        error: function (xhr) {
            showToast(xhr.responseJSON?.message || 'Terjadi kesalahan', 'error');
        }
    });
}

// ===== Modal open/close with animation =====
function openModal(modalId) {
    const modal = $(`#${modalId}`);
    const content = modal.find('[id$="Content"]');
    modal.removeClass('hidden');
    requestAnimationFrame(() => {
        content.removeClass('scale-95 opacity-0').addClass('scale-100 opacity-100');
    });
}

function closeModal(modalId) {
    const modal = $(`#${modalId}`);
    const content = modal.find('[id$="Content"]');
    content.removeClass('scale-100 opacity-100').addClass('scale-95 opacity-0');
    setTimeout(() => modal.addClass('hidden'), 200);
}

function showToast(message, type = 'success') {
    Toastify({
        text: message,
        duration: 3000,
        gravity: 'top',
        position: 'right',
        style: {
            background: type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)',
            borderRadius: '12px',
            padding: '12px 20px',
            boxShadow: '0 10px 25px -5px rgba(0,0,0,0.15)',
            fontSize: '14px',
            fontWeight: '500'
        }
    }).showToast();
}
</script>

<style>
@keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
